<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Tor Browser Simulation Helios V9">
    <title>Tor Browser</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/1/15/Tor-logo-2011-flat.svg" type="image/svg+xml">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* =========================================
           1. CORE CSS (Tor Proton Design)
           ========================================= */
        :root {
            /* Dark Theme */
            --bg-primary: #1C1B22;
            --bg-secondary: #2B2A33;
            --bg-tertiary: #42414D;
            --text-primary: #FBFBFE;
            --text-secondary: #cfcfd8;
            --accent-color: #a449ff;
            --border-color: #000;
            --input-bg: #1C1B22;
            --tor-brand: #420C5D;
            --success-color: #00D1CD;
        }

        body.light-theme {
            /* Light Theme */
            --bg-primary: #F0F0F4;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #E0E0E6;
            --text-primary: #15141A;
            --text-secondary: #5B5B66;
            --accent-color: #7D00A4;
            --border-color: #D7D7DB;
            --input-bg: #FFFFFF;
            --tor-brand: #7D00A4;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        /* --- Connection Screen --- */
        #connection-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--tor-brand); z-index: 99999;
            display: flex; align-items: center; justify-content: center;
        }
        .connect-box { display: flex; align-items: center; gap: 50px; max-width: 900px; }
        .onion-logo {
            width: 200px; height: 200px;
            background: url('https://upload.wikimedia.org/wikipedia/commons/1/15/Tor-logo-2011-flat.svg') no-repeat center/contain;
            filter: drop-shadow(0 20px 40px rgba(0,0,0,0.3));
        }
        .connect-ui h1 { font-weight: 300; font-size: 32px; margin-bottom: 10px; color: #fff; }
        .connect-ui p { font-size: 15px; line-height: 1.5; color: rgba(255,255,255,0.9); max-width: 400px; }
        .btn-connect {
            margin-top: 25px; padding: 12px 40px; background: #fff; color: var(--tor-brand);
            font-weight: 700; border-radius: 4px; border:none; cursor: pointer; transition: 0.2s;
        }
        .btn-connect:hover { transform: scale(1.02); background: #f0f0f0; }
        .progress-track { width: 100%; height: 6px; background: rgba(255,255,255,0.2); margin-top: 30px; border-radius: 3px; display: none; }
        .progress-fill { width: 0%; height: 100%; background: #fff; border-radius: 3px; transition: width 0.3s; }
        .status-text { margin-top: 10px; font-family: monospace; font-size: 13px; color: rgba(255,255,255,0.7); min-height: 20px; }

        /* --- Browser Shell --- */
        #browser-ui { display: none; flex-direction: column; height: 100%; }

        /* Tabs */
        .tab-bar {
            background-color: #0C0C0D; padding: 8px 8px 0 8px;
            display: flex; align-items: flex-end; height: 45px;
        }
        .tab {
            background: transparent; color: #b1b1b3; padding: 0 12px; height: 37px; margin-right: 4px;
            border-radius: 4px 4px 0 0; font-size: 13px; display: flex; align-items: center; gap: 8px;
            max-width: 220px; min-width: 150px; cursor: pointer; position: relative; user-select: none;
            transition: background 0.2s;
        }
        .tab:hover { background: #28282D; color: #fff; }
        .tab.active {
            background: var(--bg-secondary); color: var(--text-primary);
            box-shadow: 0 -2px 0 var(--accent-color) inset;
        }
        .tab-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tab-close {
            width: 18px; height: 18px; border-radius: 3px; display: flex; align-items: center; justify-content: center;
            opacity: 0; font-size: 10px;
        }
        .tab:hover .tab-close { opacity: 0.7; }
        .tab-close:hover { background: rgba(255,255,255,0.2); opacity: 1 !important; }
        .btn-new {
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; cursor: pointer; color: #b1b1b3; margin-bottom: 4px;
        }
        .btn-new:hover { background: #28282D; color: #fff; }

        /* Nav */
        .nav-bar {
            background-color: var(--bg-secondary); padding: 6px 10px;
            display: flex; align-items: center; gap: 4px; border-bottom: 1px solid var(--border-color);
        }
        .nav-icon {
            width: 36px; height: 36px; border-radius: 4px; background: transparent; border: none;
            color: var(--text-primary); display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 16px;
        }
        .nav-icon:hover { background: var(--bg-tertiary); }
        .url-box {
            flex: 1; margin: 0 8px; background: var(--input-bg); border: 1px solid var(--border-color);
            border-radius: 4px; height: 34px; display: flex; align-items: center; position: relative;
        }
        .url-box:focus-within { border: 2px solid var(--accent-color); box-shadow: 0 0 0 2px rgba(164, 73, 255, 0.2); }
        .onion-btn { padding: 0 10px; height: 20px; display: flex; align-items: center; cursor: pointer; border-right: 1px solid var(--bg-tertiary); }
        .onion-btn i { color: var(--accent-color); font-size: 14px; }
        #omnibox {
            flex: 1; border: none; background: transparent; color: var(--text-primary);
            font-size: 14px; padding-left: 12px; height: 100%;
        }

        /* --- Webview Container --- */
        #viewport { flex: 1; position: relative; background: #fff; overflow: hidden; }
        .webview { 
            width: 100%; height: 100%; display: none; overflow-y: auto; 
            background: #FFFFFF; /* FORCE WHITE BG FOR CONTENT */
            color: #000000;      /* FORCE BLACK TEXT FOR CONTENT */
            position: absolute; top: 0; left: 0;
        }
        .webview.active { display: block; }

        /* Loading */
        .loader {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-primary); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border-radius: 50%; border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-color); animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .load-text { margin-top: 15px; font-family: monospace; color: var(--text-secondary); }

        /* --- Menus & Pages --- */
        .popover {
            position: absolute; top: 90px; right: 10px; width: 300px;
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 5000; display: none; padding: 6px 0;
        }
        .menu-row {
            padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; color: var(--text-primary);
        }
        .menu-row:hover { background: var(--accent-color); color: #fff; }
        .sep { height: 1px; background: var(--border-color); margin: 4px 0; }

        /* Start Page */
        .start-page {
            height: 100%; background: linear-gradient(135deg, #2A083B 0%, #050505 100%);
            display: flex; flex-direction: column; align-items: center; padding-top: 120px; color: #fff;
        }
        .start-logo {
            width: 120px; height: 120px;
            background: url('https://upload.wikimedia.org/wikipedia/commons/1/15/Tor-logo-2011-flat.svg') no-repeat center/contain;
            filter: brightness(0) invert(1); opacity: 0.9;
        }
        .search-wrap {
            width: 600px; max-width: 90%; background: #fff; height: 52px;
            border-radius: 8px; margin-top: 40px; display: flex; align-items: center; padding: 0 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .search-wrap input { flex: 1; border: none; font-size: 18px; margin-left: 15px; color: #333; }

        /* Internal Pages (Settings/Help) */
        .internal-page { display: flex; height: 100%; background: var(--bg-primary); }
        .sidebar { width: 250px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px 0; }
        .sidebar-item {
            padding: 12px 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 12px; color: var(--text-primary);
        }
        .sidebar-item:hover { background: var(--bg-tertiary); }
        .sidebar-item.active { background: var(--bg-tertiary); border-left: 4px solid var(--accent-color); }
        .content-pane { flex: 1; padding: 40px 60px; overflow-y: auto; color: var(--text-primary); }
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        h1 { font-weight: 300; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .settings-card { background: var(--bg-secondary); padding: 20px; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

        .circuit-popover {
            position: absolute; top: 85px; left: 150px; width: 320px;
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 5000; display: none; padding: 15px;
        }
    </style>
</head>
<body class="dark-theme">

    <!-- 1. Connection Overlay -->
    <div id="connection-overlay">
        <div class="connect-box">
            <div class="onion-logo"></div>
            <div class="connect-ui">
                <h1>Connect to Tor</h1>
                <p>Tor Browser routes your traffic over the Tor Network, run by thousands of volunteers around the world.</p>
                <button class="btn-connect" onclick="App.boot()">Connect</button>
                <div style="margin-top:20px; font-size:14px; color:rgba(255,255,255,0.7); display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" checked> Always connect automatically
                </div>
                <div class="progress-track" id="boot-track"><div class="progress-fill" id="boot-fill"></div></div>
                <div class="status-text" id="boot-status"></div>
            </div>
        </div>
    </div>

    <!-- 2. Browser UI -->
    <div id="browser-ui">
        <div class="tab-bar" id="tab-strip">
            <div class="btn-new" onclick="Tabs.add()"><i class="fa fa-plus"></i></div>
        </div>

        <div class="nav-bar">
            <button class="nav-icon" onclick="Nav.back()"><i class="fa fa-arrow-left"></i></button>
            <button class="nav-icon" onclick="Nav.forward()"><i class="fa fa-arrow-right"></i></button>
            <button class="nav-icon" onclick="Nav.reload()"><i class="fa fa-rotate-right" style="font-size:14px"></i></button>
            
            <div class="url-box">
                <div class="onion-btn" onclick="UI.toggleCircuit()"><i class="fa-solid fa-layer-group"></i></div>
                <div class="onion-btn" onclick="Nav.to('about:preferences')"><i class="fa-solid fa-shield-halved" style="color:#b1b1b3"></i></div>
                <input type="text" id="omnibox" placeholder="Search or enter address">
            </div>

            <button class="nav-icon" onclick="UI.toggleMenu('addons')"><i class="fa fa-puzzle-piece"></i></button>
            <button class="nav-icon" onclick="UI.toggleMenu('main')"><i class="fa fa-bars"></i></button>
        </div>

        <!-- Menus -->
        <div class="popover" id="menu-main">
            <div class="menu-row" onclick="Tabs.add()"><i class="fa fa-file"></i> New Tab</div>
            <div class="menu-row"><i class="fa fa-window-maximize"></i> New Window</div>
            <div class="menu-row" onclick="Nav.newIdentity()"><i class="fa fa-broom"></i> New Identity</div>
            <div class="sep"></div>
            <div class="menu-row" onclick="Nav.to('about:preferences')"><i class="fa fa-gear"></i> Settings</div>
            <div class="menu-row" onclick="Nav.to('about:manual')"><i class="fa fa-book"></i> Tor Manual</div>
        </div>

        <div class="popover" id="menu-addons" style="right: 50px;">
            <div style="padding:10px 16px; font-weight:bold; font-size:12px; color:var(--text-secondary)">THEMES</div>
            <div class="menu-row" onclick="UI.setTheme('dark')">
                <i class="fa fa-moon"></i> Dark Reader <input type="radio" name="th" checked style="margin-left:auto">
            </div>
            <div class="menu-row" onclick="UI.setTheme('light')">
                <i class="fa fa-sun"></i> Light Beam <input type="radio" name="th" style="margin-left:auto">
            </div>
        </div>

        <div class="circuit-popover" id="circuit-display">
            <div style="font-weight:bold; margin-bottom:15px; color:var(--accent-color); border-bottom:1px solid var(--border-color); padding-bottom:5px;">Tor Circuit</div>
            <div id="circuit-list"></div>
        </div>

        <!-- Content -->
        <div id="viewport"></div>
    </div>

    <script>
        // ==========================================
        // 1. HELIOS ENGINE V9 (STABLE)
        // ==========================================
        const Helios = {
            proxies: [
                u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
                u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}` // AllOrigins returns JSON
            ],

            async fetchBlob(url) {
                // Downloads an asset and creates a local object URL
                try {
                    // CodeTabs is best for blobs
                    const res = await axios.get(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, { responseType: 'blob' });
                    if(res.status === 200) return URL.createObjectURL(res.data);
                } catch(e) {}
                return null;
            },

            async fetchText(url) {
                for (let proxyGen of this.proxies) {
                    try {
                        const proxyUrl = proxyGen(url);
                        const res = await axios.get(proxyUrl);
                        if(res.status === 200) {
                            // Fix [object Object]: Check if response is JSON wrapper from AllOrigins
                            if (proxyUrl.includes('allorigins') && res.data && res.data.contents) {
                                return res.data.contents;
                            }
                            // Otherwise standard text
                            if (typeof res.data === 'string') return res.data;
                            if (typeof res.data === 'object') return JSON.stringify(res.data);
                        }
                    } catch(e) {}
                }
                return null;
            },

            async load(url, containerId) {
                const container = document.getElementById(containerId);
                const tabId = containerId.split('-')[1];
                
                container.innerHTML = `
                    <div class="loader">
                        <div class="spinner"></div>
                        <div class="load-text" id="status-${tabId}">Requesting ${new URL(url).hostname}...</div>
                    </div>`;

                const setStatus = (msg) => {
                    const el = document.getElementById(`status-${tabId}`);
                    if(el) el.innerText = msg;
                };

                // 1. Fetch HTML
                const html = await this.fetchText(url);
                if(!html) {
                    container.innerHTML = `<div style="padding:50px; text-align:center; color:#000;"><h2>Connection Failed</h2><p>Could not reach ${url}</p></div>`;
                    return;
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const base = document.createElement('base');
                base.href = url;
                doc.head.prepend(base);

                setStatus("Securing Assets...");
                const getAbs = (rel) => { try { return new URL(rel, url).href; } catch(e){ return rel; } };

                // 2. Blob Engine (Images & CSS)
                const css = Array.from(doc.querySelectorAll('link[rel="stylesheet"]'));
                const imgs = Array.from(doc.querySelectorAll('img[src]'));

                const assetPromises = [
                    ...css.map(async (link) => {
                        const blob = await this.fetchBlob(getAbs(link.href));
                        if(blob) {
                            try {
                                const t = await (await fetch(blob)).text();
                                const s = doc.createElement('style');
                                s.textContent = t;
                                link.replaceWith(s);
                            } catch(e){}
                        }
                    }),
                    ...imgs.map(async (img) => {
                        img.removeAttribute('srcset'); 
                        const blob = await this.fetchBlob(getAbs(img.src));
                        if(blob) img.src = blob;
                    })
                ];

                // Wait for assets (max 4s)
                await Promise.race([Promise.all(assetPromises), new Promise(r => setTimeout(r, 4000))]);

                // 3. Render
                container.innerHTML = '';
                const host = document.createElement('div');
                Object.assign(host.style, { width:'100%', height:'100%', overflow:'auto', background:'#FFFFFF', color:'#000000', display:'block' });
                const shadow = host.attachShadow({ mode: 'open' });
                shadow.innerHTML = doc.documentElement.outerHTML;

                // 4. Script Rehydration
                shadow.querySelectorAll('script').forEach(s => {
                    const ns = document.createElement('script');
                    Array.from(s.attributes).forEach(a => ns.setAttribute(a.name, a.value));
                    if(s.src) ns.src = getAbs(s.src); else ns.textContent = s.textContent;
                    try { s.parentNode.replaceChild(ns, s); } catch(e){}
                });

                // 5. Interceptors
                shadow.addEventListener('click', e => {
                    const a = e.target.closest('a');
                    if(a && a.href) {
                        e.preventDefault();
                        const href = a.getAttribute('href');
                        if(!href.startsWith('blob:')) Nav.to(getAbs(href));
                    }
                });

                shadow.addEventListener('submit', e => {
                    e.preventDefault();
                    const form = e.target;
                    let action = form.getAttribute('action') || '';
                    if(!action) action = url;
                    const absAction = getAbs(action);
                    
                    const formData = new FormData(form);
                    const params = new URLSearchParams();
                    for(const pair of formData.entries()) params.append(pair[0], pair[1]);
                    
                    const nextUrl = absAction.split('?')[0] + '?' + params.toString();
                    Nav.to(nextUrl);
                });

                container.appendChild(host);

                const title = doc.title || new URL(url).hostname;
                const tab = State.tabs.find(t => t.id === tabId);
                if(tab) tab.title = title;
                document.querySelector(`#tab-btn-${tabId} .tab-title`).innerText = title;
            }
        };

        // ==========================================
        // 2. STATE & UI LOGIC
        // ==========================================
        const State = { tabs: [], activeId: null, uid: 0, searchEngine: 'google', theme: 'dark' };

        const App = {
            boot() {
                document.querySelector('.btn-connect').style.display='none';
                document.getElementById('boot-track').style.display='block';
                let i=0; const s=10;
                const t = setInterval(()=>{
                    if(i>=s){
                        clearInterval(t);
                        document.getElementById('connection-overlay').style.opacity=0;
                        setTimeout(()=>{
                            document.getElementById('connection-overlay').remove();
                            document.getElementById('browser-ui').style.display='flex';
                            Tabs.add();
                        },500);
                        return;
                    }
                    i++; document.getElementById('boot-fill').style.width=(i/s*100)+'%';
                    document.getElementById('boot-status').innerText = i<5?"Connecting...":"Handshaking...";
                },250);
            }
        };

        const Tabs = {
            add() {
                const id = 'tab-'+State.uid++;
                State.tabs.push({ id, url:'about:tor', history:[], idx:-1, title:'New Tab' });
                const btn = document.createElement('div');
                btn.className = 'tab'; btn.id = `tab-btn-${id}`;
                btn.innerHTML = `<i class="fa-brands fa-firefox-browser tab-icon"></i><span class="tab-title">New Tab</span><div class="tab-close"><i class="fa fa-times"></i></div>`;
                btn.onclick = e => e.target.closest('.tab-close') ? this.close(id) : this.switch(id);
                document.getElementById('tab-strip').insertBefore(btn, document.querySelector('.btn-new'));
                const view = document.createElement('div');
                view.className = 'webview'; view.id = `view-${id}`;
                document.getElementById('viewport').appendChild(view);
                Renderers.start(id);
                this.switch(id);
            },
            close(id) {
                if(State.tabs.length===1)return;
                const idx = State.tabs.findIndex(t=>t.id===id);
                State.tabs.splice(idx,1);
                document.getElementById(`tab-btn-${id}`).remove();
                document.getElementById(`view-${id}`).remove();
                if(State.activeId===id) this.switch(State.tabs[Math.max(0,idx-1)].id);
            },
            switch(id) {
                State.activeId = id;
                document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
                document.getElementById(`tab-btn-${id}`).classList.add('active');
                document.querySelectorAll('.webview').forEach(x=>x.classList.remove('active'));
                document.getElementById(`view-${id}`).classList.add('active');
                const t = State.tabs.find(x=>x.id===id);
                document.getElementById('omnibox').value = t.url.startsWith('about:') ? '' : t.url;
            }
        };

        const Nav = {
            to(input) {
                if(!input) return;
                UI.closeMenus();
                const id = State.activeId;
                const tab = State.tabs.find(t=>t.id===id);
                let url = input.trim();

                if(url.startsWith('about:')) {
                    if(url === 'about:preferences') Renderers.settings(id);
                    else if(url === 'about:manual') Renderers.manual(id);
                    else Renderers.start(id);
                    return;
                }

                const hasProto = url.match(/^https?:\/\//);
                const isDomain = url.includes('.') && !url.includes(' ');
                
                if(!hasProto && !isDomain) {
                    if(State.searchEngine === 'google') 
                        url = `https://www.google.com/search?q=${encodeURIComponent(url)}&igu=1`;
                    else if(State.searchEngine === '4get')
                        url = `https://4get.ca/web?q=${encodeURIComponent(url)}`;
                    else 
                        url = `https://html.duckduckgo.com/html?q=${encodeURIComponent(url)}`;
                } else if(!hasProto) url = 'https://' + url;

                tab.url = url;
                document.getElementById('omnibox').value = url;
                if(tab.idx < tab.history.length-1) tab.history = tab.history.slice(0, tab.idx+1);
                tab.history.push(url);
                tab.idx++;
                Helios.load(url, `view-${id}`);
            },
            back() { const t=State.tabs.find(x=>x.id===State.activeId); if(t.idx>0){ t.idx--; this.to(t.history[t.idx]); } },
            forward() { const t=State.tabs.find(x=>x.id===State.activeId); if(t.idx<t.history.length-1){ t.idx++; this.to(t.history[t.idx]); } },
            reload() { const t=State.tabs.find(x=>x.id===State.activeId); if(!t.url.startsWith('about:')) Helios.load(t.url, `view-${State.activeId}`); },
            newIdentity() { document.body.style.opacity='0'; setTimeout(()=>location.reload(),500); }
        };

        const Renderers = {
            start(id) {
                const v = document.getElementById(`view-${id}`);
                const t = State.tabs.find(x=>x.id===id);
                t.url='about:tor'; t.title='New Tab';
                document.querySelector(`#tab-btn-${id} .tab-title`).innerText = 'New Tab';
                document.getElementById('omnibox').value = '';
                
                let placeholder = "Search or enter address";
                if(State.searchEngine === 'google') placeholder = "Search with Google";
                if(State.searchEngine === 'duckduckgo') placeholder = "Search with DuckDuckGo";
                if(State.searchEngine === '4get') placeholder = "Search with 4get";

                v.innerHTML = `
                    <div class="start-page">
                        <div class="start-logo"></div>
                        <h1 style="font-weight:300; margin-top:20px;">Tor Browser</h1>
                        <p style="font-size:18px; opacity:0.8;">Explore. Privately.</p>
                        <div class="search-wrap">
                            <input type="text" placeholder="${placeholder}" 
                            onkeydown="if(event.key==='Enter') Nav.to(this.value)">
                        </div>
                    </div>`;
            },
            manual(id) {
                const v = document.getElementById(`view-${id}`);
                const t = State.tabs.find(x=>x.id===id);
                t.url='about:manual'; t.title='Tor Manual';
                document.querySelector(`#tab-btn-${id} .tab-title`).innerText='Tor Manual';
                document.getElementById('omnibox').value='about:manual';
                v.innerHTML = `
                    <div class="internal-page">
                        <div class="sidebar">
                            <div class="sidebar-item active" onclick="UI.swSec(this,'m1')">About</div>
                            <div class="sidebar-item" onclick="UI.swSec(this,'m2')">Circuits</div>
                            <div class="sidebar-item" onclick="UI.swSec(this,'m3')">Onion</div>
                        </div>
                        <div class="content-pane">
                            <div id="m1" class="page-section active"><h1>About Tor</h1><p>Tor Browser uses the Tor network to protect your privacy and anonymity.</p></div>
                            <div id="m2" class="page-section"><h1>Circuits</h1><p>A circuit is a path through the Tor network (Guard -> Middle -> Exit).</p></div>
                            <div id="m3" class="page-section"><h1>Onion Services</h1><p>Onion services (.onion) provide end-to-end encryption.</p></div>
                        </div>
                    </div>`;
            },
            settings(id) {
                const v = document.getElementById(`view-${id}`);
                const t = State.tabs.find(x=>x.id===id);
                t.url='about:preferences'; t.title='Settings';
                document.querySelector(`#tab-btn-${id} .tab-title`).innerText='Settings';
                document.getElementById('omnibox').value='about:preferences';
                v.innerHTML = `
                    <div class="internal-page">
                        <div class="sidebar">
                            <div class="sidebar-item active" onclick="UI.swSec(this,'s1')">General</div>
                            <div class="sidebar-item" onclick="UI.swSec(this,'s2')">Search</div>
                            <div class="sidebar-item" onclick="UI.swSec(this,'s3')">Privacy</div>
                        </div>
                        <div class="content-pane">
                            <div id="s1" class="page-section active"><h1>General</h1><div class="settings-card"><div class="settings-row"><span>Startup</span><input type="checkbox" checked></div></div></div>
                            <div id="s2" class="page-section"><h1>Search</h1><div class="settings-card">
                                <div class="settings-row" onclick="State.searchEngine='google';Nav.to('about:preferences')"><span>Google (Default)</span><input type="radio" ${State.searchEngine==='google'?'checked':''}></div>
                                <div class="settings-row" onclick="State.searchEngine='duckduckgo';Nav.to('about:preferences')"><span>DuckDuckGo</span><input type="radio" ${State.searchEngine==='duckduckgo'?'checked':''}></div>
                                <div class="settings-row" onclick="State.searchEngine='4get';Nav.to('about:preferences')"><span>4get</span><input type="radio" ${State.searchEngine==='4get'?'checked':''}></div>
                            </div></div>
                            <div id="s3" class="page-section"><h1>Privacy</h1><div class="settings-card"><strong>Security Level</strong><p>Standard</p></div></div>
                        </div>
                    </div>`;
            }
        };

        const UI = {
            toggleMenu(id) {
                const el = document.getElementById(`menu-${id}`);
                const v = el.style.display==='block';
                this.closeMenus();
                if(!v) el.style.display='block';
            },
            toggleCircuit() {
                const el = document.getElementById('circuit-display');
                const v = el.style.display==='block';
                this.closeMenus();
                if(!v) {
                    el.innerHTML = '<div style="font-weight:bold;color:var(--accent-color);margin-bottom:10px">Tor Circuit</div><div>This Browser</div><div style="margin-left:10px;border-left:2px solid #555;padding-left:10px"><div>Guard</div><div>Relay</div><div>Relay</div></div><div>Internet</div>';
                    el.style.display='block';
                }
            },
            closeMenus() { document.querySelectorAll('.popover, .circuit-popover').forEach(x=>x.style.display='none'); },
            setTheme(t) { State.theme=t; document.body.className = t==='light'?'light-theme':'dark-theme'; },
            swSec(el, id) {
                const r = el.closest('.internal-page');
                r.querySelectorAll('.sidebar-item').forEach(x=>x.classList.remove('active'));
                el.classList.add('active');
                r.querySelectorAll('.page-section').forEach(x=>x.classList.remove('active'));
                r.querySelector('#'+id).classList.add('active');
            }
        };

        // Init
        document.getElementById('omnibox').addEventListener('keydown', e => { if(e.key==='Enter') Nav.to(e.target.value); });
        window.onclick = e => { if(!e.target.closest('.nav-icon') && !e.target.closest('.popover') && !e.target.closest('.circuit-popover')) UI.closeMenus(); };

    </script>
</body>
</html>
